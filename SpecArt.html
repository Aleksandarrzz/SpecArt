<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SpecArt 0.0.1.33</title>
<style>
body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 10px; font-size: 0.85rem; }
#dateTitleRow { position: relative; height: 30px; margin-bottom: 5px; }
#dateField { position: absolute; left: 0; top: 0; padding: 3px; font-size: 0.8rem; }
#printTitle { text-align: center; font-size: 1rem; font-weight: bold; line-height: 30px; display: block; }
#buttonsRow { position:absolute; top:0; right:0; display:flex; gap:5px; align-items:center; }
button { margin: 3px; padding:6px 12px; font-size:0.8rem; cursor:pointer; }
table { border-collapse: collapse; margin: 5px; background: white; box-shadow: 0 0 4px #ccc; width: 100%; font-size: 0.75rem; }
th, td { border: 1px solid #ddd; padding: 4px; text-align: center; }
th { background: #333; color: white; }
input.qty-input { width: 40px; font-size: 0.75rem; text-align: center; }
input.amount-input { width: 100px; font-size: 0.75rem; padding: 2px; }
.tables-grid { display: grid; grid-template-columns: 1fr 1fr; grid-gap: 10px; margin-top: 10px; }
.currency-block { background: white; padding: 5px; border-radius: 4px; box-shadow: 0 0 4px #ccc; position: relative; }
.currency-block h3 { text-align: center; margin: 4px 0; font-size: 0.9rem; }
.message { text-align: center; font-size: 0.8rem; font-weight: bold; margin-top: 4px; }
#addCurrencyBtnContainer { margin-top: 10px; text-align: center; }
.delete-table { position:absolute; top:2px; right:2px; font-weight:bold; cursor:pointer; color:red; display:none; }
.checkbox-container { display:flex; align-items:center; gap:3px; margin-left:10px; font-size:0.8rem; cursor:pointer; }

/* Print & PDF styles */
@media print {
  @page { size: A4 portrait; margin: 10mm; }
  body { background: white; font-size: 0.75rem; }
  #buttonsRow, .amount-input, button, .delete-table, .checkbox-container { display: none !important; }
  table { width: 100%; box-shadow: none; font-size: 0.7rem; }
  th { color: black !important; background: none !important; }
  td { color: black !important; }
  input.qty-input { border: none !important; outline: none !important; width: auto; text-align: center; font-size:0.7rem; }
  .message { display: none !important; }
  select.currency-select, .currency-block h3 { border:none !important; outline:none !important; background:transparent !important; -webkit-appearance:none; -moz-appearance:none; appearance:none; }
  #printHeader { display:block; text-align:center; margin-bottom:10px; font-weight:bold; font-size:1rem; }
  #printDate { display:block; text-align:center; margin-bottom:5px; font-size:0.85rem; }
}
body.pdf-mode { background:white; font-size:0.75rem; }
body.pdf-mode #buttonsRow, body.pdf-mode .amount-input, body.pdf-mode button, body.pdf-mode .message, body.pdf-mode .delete-table, body.pdf-mode .checkbox-container { display:none !important; }
body.pdf-mode table { width:100%; box-shadow:none; font-size:0.7rem; }
body.pdf-mode th { color:black !important; background:none !important; }
body.pdf-mode td { color:black !important; }
body.pdf-mode input.qty-input { border:none !important; outline:none !important; width:auto; text-align:center; font-size:0.7rem; }
body.pdf-mode select.currency-select, body.pdf-mode .currency-block h3 { border:none !important; outline:none !important; background:transparent !important; -webkit-appearance:none; -moz-appearance:none; appearance:none; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
<div id="dateTitleRow">
  <input type="date" id="dateField" />
  <span id="printTitle">Specifikacija novca</span>
  <div id="buttonsRow">
    <label class="checkbox-container">
  <input type="checkbox" id="hideEmpty"> Sakrij prazne
  <span class="info-icon" title="Kada je čekirano, sakriva prazne apoene u štampi i PDF-u">i</span>
</label>

    <button id="saveBtn">Sačuvaj</button>
    <button id="printBtn">Štampaj</button>
    <button id="savePrintBtn">Sačuvaj i štampaj</button>
  </div>
</div>
<div id="printHeader" style="display:none;">Specifikacija novca</div>
<div id="printDate" style="display:none;"></div>

<div class="tables-grid" id="tablesGrid">
  <div class="currency-block" data-currency="rsd">
    <span class="delete-table">×</span>
    <h3>
      <select class="currency-select">
        <option value="aud">AUD</option>
        <option value="bam">BAM</option>
        <option value="cad">CAD</option>
        <option value="chf">CHF</option>
        <option value="eur">EUR</option>
        <option value="gbp">GBP</option>
        <option value="hrk">HRK</option>
        <option value="rsd" selected>RSD</option>
        <option value="usd">USD</option>
      </select>
    </h3>
    <div style="text-align:center;">
      <input type="number" class="amount-input" placeholder="Iznos RSD" />
      <button class="generateBtn">Generiši</button>
    </div>
    <table>
      <thead><tr><th>Apoen</th><th>Količina</th><th>Vrednost</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><th colspan="2">Ukupno:</th><th class="totalValue"></th></tr></tfoot>
    </table>
    <div class="message"></div>
  </div>
</div>

<div id="addCurrencyBtnContainer">
  <button id="addCurrencyBtn">Dodaj valutu</button>
</div>

<script>
(() => {
const allDenominations = {
  rsd:[5000,2000,1000,500,200,100,50,20,10,5,2,1],
  eur:[500,200,100,50,20,10,5],
  usd:[100,50,20,10,5,1],
  chf:[1000,200,100,50,20,10],
  cad:[100,50,20,10,5],
  gbp:[50,20,10,5,2,1],
  bam:[100,50,20,10,5],
  hrk:[500,200,100,50,20,10,5],
  aud:[100,50,20,10,5,2,1]
};
const allWeights = {
  rsd:{5000:0.019,2000:0.51,1000:0.39,500:0.023,200:0.0078,100:0.0066,50:0.00091,20:0.00072,10:0.0007,5:0.00006,2:0.00005,1:0.000011},
  eur:{500:0.2,200:0.11,100:0.25,50:0.31,20:0.07,10:0.02,5:0.01},
  usd:{100:0.4,50:0.25,20:0.2,10:0.1,5:0.04,1:0.01},
  chf:{1000:0.35,200:0.25,100:0.2,50:0.1,20:0.07,10:0.03},
  cad:{100:0.4,50:0.25,20:0.2,10:0.1,5:0.05},
  gbp:{50:0.35,20:0.3,10:0.2,5:0.15,2:0.05,1:0.05},
  bam:{100:0.4,50:0.25,20:0.2,10:0.1,5:0.05},
  hrk:{500:0.35,200:0.25,100:0.2,50:0.1,20:0.07,10:0.03,5:0.02},
  aud:{100:0.4,50:0.25,20:0.2,10:0.1,5:0.04,2:0.01,1:0.005}
};
const maxOneDinarCount = 49;
let state = {};
const hideEmptyCheckbox = document.getElementById('hideEmpty');
document.getElementById('dateField').value = new Date().toISOString().split('T')[0];
document.getElementById('printDate').textContent = document.getElementById('dateField').value;

function generateSpec(amount, denomArr, weightsObj, isRSD=false){
  let counts={}, totalDistributed=0;
  const totalWeight=Object.values(weightsObj).reduce((a,b)=>a+b,0);
  for(let denom of denomArr) counts[denom]=Math.floor(amount*(weightsObj[denom]/totalWeight)/denom);
  for(let denom of denomArr) totalDistributed+=counts[denom]*denom;
  if(isRSD && counts[1]>maxOneDinarCount){ let diff=counts[1]-maxOneDinarCount; counts[1]=maxOneDinarCount; totalDistributed-=diff; }
  let remainder=amount-totalDistributed;
  for(let pass=0; pass<3 && remainder>0; pass++){
    for(let denom of denomArr){
      while(remainder>=denom){ counts[denom]=(counts[denom]||0)+1; remainder-=denom; }
    }
  }
  return counts;
}

function renderTable(block){
  const currency = block.dataset.currency;
  const denomArr = allDenominations[currency];
  const tbody = block.querySelector('tbody');
  const totalValueEl = block.querySelector('.totalValue');
  tbody.innerHTML='';
  let totalValue=0;
  const counts = state[currency] || {};
  for(let denom of denomArr){
    const count = counts[denom]||0;
    const value = count*denom;
    totalValue+=value;
    const row=document.createElement('tr');
    row.innerHTML=`<td>${denom}</td><td><input type="number" min="0" class="qty-input" data-denom="${denom}" data-currency="${currency}" value="${count}"></td><td>${value.toLocaleString('sr-RS')}</td>`;
    tbody.appendChild(row);
  }
  totalValueEl.textContent=totalValue.toLocaleString('sr-RS');
  updateMessage(block);
}

function updateMessage(block){
  const currency = block.dataset.currency;
  const counts = state[currency]||{};
  const denomArr = allDenominations[currency];
  const amountInput = block.querySelector('.amount-input');
  const amount = parseInt(amountInput.value)||0;
  let totalValue=0;
  for(let denom of denomArr) totalValue+=(counts[denom]||0)*denom;
  const diff=totalValue-amount;
  const messageEl = block.querySelector('.message');
  if(diff===0){ messageEl.textContent="Iznos je tačan!"; messageEl.style.color="green"; }
  else if(diff>0){ messageEl.textContent="Višak "+diff.toLocaleString('sr-RS'); messageEl.style.color="red"; }
  else{ messageEl.textContent="Manjak "+(-diff).toLocaleString('sr-RS'); messageEl.style.color="orange"; }
}

function setupBlock(block){
  const amountInput = block.querySelector('.amount-input');
  const generateBtn = block.querySelector('.generateBtn');
  const currencySelect = block.querySelector('.currency-select');
  const deleteBtn = block.querySelector('.delete-table');
  block.dataset.currency = currencySelect.value;
  state[block.dataset.currency] = {};

  generateBtn.addEventListener('click', ()=>{ const currency = block.dataset.currency; const amount = parseInt(amountInput.value); if(isNaN(amount)||amount<=0){ alert("Unesite validan iznos!"); return; } state[currency] = generateSpec(amount, allDenominations[currency], allWeights[currency], currency==='rsd'); renderTable(block); });

  currencySelect.addEventListener('change', ()=>{ const newCurrency = currencySelect.value; block.dataset.currency = newCurrency; amountInput.placeholder = "Iznos "+newCurrency.toUpperCase(); amountInput.value=''; state[newCurrency]={}; renderTable(block); });

  // ---- IZMENJENI input handler da ne pomera kursor ----
  let inputTimeout;
  block.addEventListener('input', e=>{
    if(!e.target.classList.contains('qty-input')) return;
    const denom=parseInt(e.target.dataset.denom);
    const currency=e.target.dataset.currency;
    let val=parseInt(e.target.value);
    if(isNaN(val)||val<0){ val=0; e.target.value=0; }
    state[currency][denom]=val;
    if(inputTimeout) clearTimeout(inputTimeout);
    inputTimeout = setTimeout(()=>{ renderTable(block); }, 300);
  });
  // ---- kraj izmene ----

  amountInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); generateBtn.click(); } });

  deleteBtn.addEventListener('click', ()=>{ const blocks = document.querySelectorAll('.currency-block'); if(blocks.length>1){ block.remove(); } else alert("Prva tabela ne može da se ukloni!"); });

  if(document.querySelectorAll('.currency-block').length>1) deleteBtn.style.display='block';
}

document.querySelectorAll('.currency-block').forEach(setupBlock);

document.getElementById('addCurrencyBtn').addEventListener('click', ()=>{ 
  const existing = [...document.querySelectorAll('.currency-block')].map(b=>b.dataset.currency);
  const allCurrencies=['aud','bam','cad','chf','eur','gbp','hrk','rsd','usd'];
  const nextCurrency = allCurrencies.find(c=>!existing.includes(c));
  if(!nextCurrency){ alert("Sve valute su već dodate!"); return; }
  const newBlock = document.createElement('div');
  newBlock.className='currency-block';
  newBlock.dataset.currency=nextCurrency;
  newBlock.innerHTML=`<span class="delete-table">×</span>
    <h3>
      <select class="currency-select">
        <option value="aud">AUD</option>
        <option value="bam">BAM</option>
        <option value="cad">CAD</option>
        <option value="chf">CHF</option>
        <option value="eur">EUR</option>
        <option value="gbp">GBP</option>
        <option value="hrk">HRK</option>
        <option value="rsd">RSD</option>
        <option value="usd">USD</option>
      </select>
    </h3>
    <div style="text-align:center;">
      <input type="number" class="amount-input" placeholder="Iznos ${nextCurrency.toUpperCase()}" />
      <button class="generateBtn">Generiši</button>
    </div>
    <table>
      <thead><tr><th>Apoen</th><th>Količina</th><th>Vrednost</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><th colspan="2">Ukupno:</th><th class="totalValue"></th></tr></tfoot>
    </table>
    <div class="message"></div>`;
  document.getElementById('tablesGrid').appendChild(newBlock);
  const sel = newBlock.querySelector('.currency-select');
  sel.value = nextCurrency;
  setupBlock(newBlock);
});

function generatePDF(callback){
  const hideEmpty = hideEmptyCheckbox.checked;
  document.body.classList.add('pdf-mode');
  document.getElementById('printHeader').style.display='block';
  document.getElementById('printDate').style.display='block';
  document.getElementById('printDate').textContent = document.getElementById('dateField').value;
  document.querySelectorAll('tbody tr').forEach(r=>{
    const val = parseInt(r.querySelector('input.qty-input').value)||0;
    if(hideEmpty && val===0){ r.style.display='none'; }
  });
  html2pdf().set({ margin:10, filename:`Specifikacija_${document.getElementById('dateField').value}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} }).from(document.body).save().then(()=>{
    document.body.classList.remove('pdf-mode');
    document.getElementById('printHeader').style.display='none';
    document.getElementById('printDate').style.display='none';
    document.querySelectorAll('tbody tr').forEach(r=>{ r.style.display='table-row'; });
    if(callback) callback();
  });
}

document.getElementById('printBtn').addEventListener('click', ()=>{ 
  const hideEmpty = hideEmptyCheckbox.checked;
  if(hideEmpty){
    document.querySelectorAll('tbody tr').forEach(r=>{ const val = parseInt(r.querySelector('input.qty-input').value)||0; if(val===0) r.style.display='none'; });
    window.print();
    document.querySelectorAll('tbody tr').forEach(r=>r.style.display='table-row');
  }else{ window.print(); }
});
document.getElementById('saveBtn').addEventListener('click', ()=>{ generatePDF(); });
document.getElementById('savePrintBtn').addEventListener('click', ()=>{ generatePDF(()=>window.print()); });
})();
</script>

<div class="build-info">Build 0.0.1.33</div>
<style>
.build-info { position: fixed; bottom:5px; left:50%; transform:translateX(-50%); font-size:0.75rem; color:#555; }
@media print { .build-info{display:none !important;} }
body.pdf-mode .build-info{display:none !important;}
.info-icon {
  display: inline-block;
  width: 16px;
  height: 16px;
  line-height: 16px;
  border-radius: 50%;
  background: black;
  color: white;
  text-align: center;
  font-weight: bold;
  margin-left: 5px;
  font-size: 0.75rem;
  cursor: pointer;
  position: relative;
}

.info-icon:hover::after {
  content: attr(title);
  position: absolute;
  bottom: 125%; /* iznad ikone */
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: #fff;
  padding: 4px 6px;
  border-radius: 4px;
  white-space: nowrap;
  font-size: 0.7rem;
  z-index: 10;
  opacity: 1;
  visibility: visible;
}

.info-icon::after {
  content: '';
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s;
}

</style>
</body>
</html>
